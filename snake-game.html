<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        /* ==================== å…¨å±€æ ·å¼è®¾ç½® ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* ä½¿ç”¨ Apple ç³»ç»Ÿå­—ä½“ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            /* ç–¯ç‹‚åŠ¨ç‰©åŸå¤©ç©ºè“è‰²æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(180deg, #4A90E2 0%, #7EC8E3 50%, #B8E0F0 100%);
            /* è®©å†…å®¹å‚ç›´å’Œæ°´å¹³å±…ä¸­ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* ç¦æ­¢æ–‡å­—é€‰ä¸­ï¼ˆæ¸¸æˆä½“éªŒæ›´å¥½ï¼‰ */
            user-select: none;
            /* æ·»åŠ èƒŒæ™¯åŠ¨ç”» */
            animation: gradientShift 20s ease infinite;
            background-size: 200% 200%;
            position: relative;
        }

        /* æ·»åŠ åŸå¸‚è½®å»“æ•ˆæœ */
        body::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to top, rgba(52, 73, 94, 0.3) 0%, transparent 100%);
            pointer-events: none;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ==================== æ¸¸æˆå®¹å™¨ ==================== */
        .game-container {
            text-align: center;
            /* æ·»åŠ é˜´å½±æ•ˆæœï¼Œè®©å®¹å™¨æ›´ç«‹ä½“ */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* ==================== æ ‡é¢˜æ ·å¼ ==================== */
        h1 {
            color: #1d1d1f;
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        /* ==================== å‰¯æ ‡é¢˜æ ·å¼ ==================== */
        .subtitle {
            color: #86868b;
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* ==================== åˆ†æ•°é¢æ¿ ==================== */
        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 20px;
        }

        .score-item {
            background: linear-gradient(135deg, #4A90E2 0%, #3B7BC4 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 15px;
            min-width: 150px;
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
            transition: all 0.3s ease;
        }

        .score-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(74, 144, 226, 0.6);
        }

        .score-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 32px;
            font-weight: 700;
        }

        /* ==================== æ¸¸æˆç”»å¸ƒ ==================== */
        #gameCanvas {
            /* æ·»åŠ è¾¹æ¡† */
            border: 4px solid rgba(74, 144, 226, 0.3);
            border-radius: 20px;
            /* æ·»åŠ é˜´å½± */
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.3);
            display: block;
            margin: 0 auto 20px;
            /* åŸå¸‚é“è·¯ç°è‰²èƒŒæ™¯ */
            background: linear-gradient(135deg, #E8EEF2 0%, #D5E1E8 100%);
        }

        /* ==================== æ§åˆ¶æŒ‰é’® ==================== */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #4A90E2 0%, #3B7BC4 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        button:hover {
            background: linear-gradient(135deg, #3B7BC4 0%, #2E5F9E 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        /* ==================== æç¤ºä¿¡æ¯ ==================== */
        .instructions {
            margin-top: 20px;
            color: #86868b;
            font-size: 14px;
            line-height: 1.8;
        }

        .key {
            background: #f5f5f7;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            color: #1d1d1f;
            margin: 0 2px;
        }

        /* ==================== æ¸¸æˆç»“æŸæç¤º ==================== */
        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px 60px;
            border-radius: 20px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }

        .game-over.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .game-over h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .game-over p {
            font-size: 18px;
            color: #86868b;
            margin-bottom: 30px;
        }

        /* ==================== å…³å¡é€‰æ‹©ç•Œé¢ ==================== */
        .level-select {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
            max-width: 600px;
            width: 90%;
        }

        .level-select.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        .level-select h2 {
            font-size: 32px;
            margin-bottom: 30px;
            color: #1d1d1f;
            text-align: center;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .level-card {
            background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .level-card:hover:not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4);
            border-color: #4A90E2;
        }

        .level-card.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .level-card.completed {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
        }

        .level-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .level-name {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .level-subtitle {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .level-target {
            font-size: 14px;
            color: #4A90E2;
            font-weight: 500;
        }

        .level-lock {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
        }

        .level-check {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
        }

        .level-progress {
            margin-top: 20px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .progress-bar {
            background: #f5f5f7;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4A90E2, #7EC8E3);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .close-level-select {
            margin-top: 20px;
            width: 100%;
        }

        /* ==================== å½“å‰å…³å¡ä¿¡æ¯æ˜¾ç¤º ==================== */
        .current-level-info {
            background: linear-gradient(135deg, #F59E0B 0%, #F97316 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .level-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-info-icon {
            font-size: 24px;
        }

        .level-info-text {
            font-size: 14px;
            font-weight: 600;
        }

        .level-target-info {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
    <div class="level-select" id="levelSelect">
        <h2>ğŸ—ºï¸ å…³å¡é€‰æ‹©</h2>
        <div class="level-grid" id="levelGrid">
            <!-- å…³å¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="level-progress">
            <div style="font-size: 14px; color: #86868b; margin-bottom: 10px;">æ€»è¿›åº¦</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div style="font-size: 14px; color: #86868b; margin-top: 10px;">
                ğŸ† æˆå°±: <span id="achievementCount">0</span>/11
            </div>
        </div>
        <button class="close-level-select" onclick="closeLevelSelect()">è¿”å›</button>
    </div>

    <div class="game-container" id="gameContainer">
        <h1>ğŸ¦Š ç–¯ç‹‚åŠ¨ç‰©åŸ Â· è´ªåƒè›‡</h1>
        <p class="subtitle">Nickçš„è“è“å¤§å†’é™©</p>

        <!-- å½“å‰å…³å¡ä¿¡æ¯ -->
        <div class="current-level-info" id="levelInfo">
            <div class="level-info-left">
                <span class="level-info-icon" id="currentLevelIcon">ğŸ¥•</span>
                <span class="level-info-text" id="currentLevelName">ç¬¬1å…³ Â· å…”å­é•‡å†œåœº</span>
            </div>
            <div class="level-target-info">
                ç›®æ ‡: <span id="currentTarget">50</span>åˆ†
            </div>
        </div>

        <!-- åˆ†æ•°æ˜¾ç¤º -->
        <div class="score-board">
            <div class="score-item">
                <div class="score-label">å½“å‰åˆ†æ•°</div>
                <div class="score-value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">æœ€é«˜åˆ†æ•°</div>
                <div class="score-value" id="highScore">0</div>
            </div>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="gameCanvas" width="400" height="400"></canvas>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
            <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
            <button onclick="togglePause()">æš‚åœ/ç»§ç»­</button>
        </div>

        <!-- æ“ä½œè¯´æ˜ -->
        <div class="instructions">
            <p>ä½¿ç”¨ <span class="key">â†‘</span> <span class="key">â†“</span> <span class="key">â†</span> <span class="key">â†’</span> æ–¹å‘é”®æ§åˆ¶è›‡çš„ç§»åŠ¨</p>
            <p>æŒ‰ <span class="key">ç©ºæ ¼</span> é”®æš‚åœ/ç»§ç»­æ¸¸æˆ</p>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="game-over" id="gameOver">
        <h2>æ¸¸æˆç»“æŸ</h2>
        <p>ä½ çš„åˆ†æ•°: <strong id="finalScore">0</strong></p>
        <button onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
        <button onclick="startGame()">å†æ¥ä¸€å±€</button>
    </div>

    <script>
        /* ==================== æ¸¸æˆé…ç½®å’Œå¸¸é‡ ==================== */

        // æ¸¸æˆå¸¸é‡é…ç½®
        const GRID_SIZE = 20;              // æ¯ä¸ªæ ¼å­çš„å¤§å°ï¼ˆåƒç´ ï¼‰
        const CANVAS_WIDTH = 400;          // ç”»å¸ƒå®½åº¦
        const CANVAS_HEIGHT = 400;         // ç”»å¸ƒé«˜åº¦
        const SCORE_PER_FOOD = 10;         // æ¯ä¸ªé£Ÿç‰©çš„åˆ†æ•°
        const SPEED_INCREASE_INTERVAL = 50; // æ¯åƒå¤šå°‘åˆ†åŠ é€Ÿ
        const SPEED_DECREASE = 20;         // æ¯æ¬¡åŠ é€Ÿå‡å°‘çš„æ¯«ç§’æ•°
        const MAX_PARTICLES = 30;          // æœ€å¤§ç²’å­æ•°é‡
        const PARTICLE_SPAWN_COUNT = 15;   // åƒé£Ÿç‰©æ—¶ç”Ÿæˆçš„ç²’å­æ•°

        // ç¼“å­˜DOMå…ƒç´ å¼•ç”¨
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const finalScoreElement = document.getElementById('finalScore');
        const gameOverElement = document.getElementById('gameOver');
        const levelSelectElement = document.getElementById('levelSelect');
        const levelGridElement = document.getElementById('levelGrid');
        const progressFillElement = document.getElementById('progressFill');
        const achievementCountElement = document.getElementById('achievementCount');
        const currentLevelIconElement = document.getElementById('currentLevelIcon');
        const currentLevelNameElement = document.getElementById('currentLevelName');
        const currentTargetElement = document.getElementById('currentTarget');

        // åŠ è½½ç‹ç‹¸å¤´åƒå›¾ç‰‡
        const foxImage = new Image();
        foxImage.src = '151dc18c34cc03ad80af42996eeea72f.jpg';
        let imageLoaded = false;
        foxImage.onload = function() {
            imageLoaded = true;
            draw(); // å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°ç»˜åˆ¶
        };

        // è®¡ç®—ç”»å¸ƒèƒ½å®¹çº³å¤šå°‘ä¸ªæ ¼å­
        const gridSize = GRID_SIZE; // ä¿ç•™å…¼å®¹æ€§
        const tileCount = CANVAS_WIDTH / GRID_SIZE;

        // è›‡çš„åˆå§‹ä½ç½®å’Œå±æ€§ï¼ˆå¼€å±€3èŠ‚èº«ä½“ï¼‰
        let snake = [
            {x: 10, y: 10},  // è›‡å¤´
            {x: 9, y: 10},   // è›‡èº«ç¬¬äºŒèŠ‚
            {x: 8, y: 10}    // è›‡èº«ç¬¬ä¸‰èŠ‚ï¼ˆå°¾å·´ï¼‰
        ];

        // è›‡çš„ç§»åŠ¨æ–¹å‘ (dx: xæ–¹å‘, dy: yæ–¹å‘)
        let dx = 0;  // åˆå§‹ä¸ç§»åŠ¨
        let dy = 0;

        // é£Ÿç‰©çš„ä½ç½®
        let foodX = 15;
        let foodY = 15;

        // æ¸¸æˆçŠ¶æ€
        let score = 0;           // å½“å‰åˆ†æ•°
        let highScore = 0;       // æœ€é«˜åˆ†
        let gameRunning = false; // æ¸¸æˆæ˜¯å¦æ­£åœ¨è¿è¡Œ
        let gamePaused = false;  // æ¸¸æˆæ˜¯å¦æš‚åœ
        let gameSpeed = 350;     // æ¸¸æˆé€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰ - éå¸¸æ…¢çš„åˆå§‹é€Ÿåº¦
        let gameLoop;            // æ¸¸æˆå¾ªç¯å®šæ—¶å™¨

        // ğŸ¨ ç²’å­ç‰¹æ•ˆç³»ç»Ÿ
        let particles = [];      // ç²’å­æ•°ç»„
        let eatAnimation = 0;    // åƒé£Ÿç‰©åŠ¨ç”»è®¡æ—¶å™¨

        // ğŸ† æˆå°±ç³»ç»Ÿ
        let achievements = {
            firstBlueberry: false,  // ç¬¬ä¸€é¢—è“è“
            score50: false,          // è¾¾åˆ°50åˆ†
            score100: false,         // è¾¾åˆ°100åˆ†
            speedDemon: false,       // é€Ÿåº¦è¾¾åˆ°æœ€å¿«
            longSnake: false,        // è›‡é•¿åº¦è¶…è¿‡10èŠ‚
            // å…³å¡æˆå°±
            level1Complete: false,   // å®Œæˆç¬¬1å…³
            level2Complete: false,   // å®Œæˆç¬¬2å…³
            level3Complete: false,   // å®Œæˆç¬¬3å…³
            level4Complete: false,   // å®Œæˆç¬¬4å…³
            level5Complete: false    // å®Œæˆç¬¬5å…³
        };

        // ğŸ—ºï¸ å…³å¡ç³»ç»Ÿ
        let currentLevel = 1;        // å½“å‰å…³å¡
        let obstacles = [];          // éšœç¢ç‰©æ•°ç»„

        // å…³å¡é…ç½®æ•°æ®
        const levels = [
            {
                id: 1,
                name: "å…”å­é•‡å†œåœº",
                icon: "ğŸ¥•",
                subtitle: "Judyçš„å®¶ä¹¡",
                target: 50,
                startSpeed: 350,
                minSpeed: 200,
                obstacles: [],
                background: {
                    canvas: "linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)",
                    body: "linear-gradient(180deg, #81C784 0%, #66BB6A 50%, #4CAF50 100%)"
                },
                unlocked: true
            },
            {
                id: 2,
                name: "åŠ¨ç‰©åŸä¸­å¿ƒ",
                icon: "ğŸ™ï¸",
                subtitle: "ç¹åå¸‚ä¸­å¿ƒ",
                target: 100,
                startSpeed: 300,
                minSpeed: 150,
                obstacles: [
                    {x: 5, y: 5}, {x: 6, y: 5}, {x: 5, y: 6}, {x: 6, y: 6},
                    {x: 14, y: 5}, {x: 15, y: 5}, {x: 14, y: 6}, {x: 15, y: 6},
                    {x: 5, y: 14}, {x: 6, y: 14}, {x: 5, y: 15}, {x: 6, y: 15},
                    {x: 14, y: 14}, {x: 15, y: 14}, {x: 14, y: 15}, {x: 15, y: 15}
                ],
                background: {
                    canvas: "linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)",
                    body: "linear-gradient(180deg, #4A90E2 0%, #7EC8E3 50%, #B8E0F0 100%)"
                },
                unlocked: false
            },
            {
                id: 3,
                name: "åŒ—æå†°å·åŒº",
                icon: "â„ï¸",
                subtitle: "Mr. Bigçš„é¢†åœ°",
                target: 150,
                startSpeed: 250,
                minSpeed: 100,
                obstacles: [
                    {x: 3, y: 10}, {x: 4, y: 10}, {x: 5, y: 10},
                    {x: 10, y: 3}, {x: 10, y: 4}, {x: 10, y: 5},
                    {x: 16, y: 10}, {x: 17, y: 10}, {x: 18, y: 10},
                    {x: 10, y: 16}, {x: 10, y: 17}, {x: 10, y: 18}
                ],
                background: {
                    canvas: "linear-gradient(135deg, #E0F7FA 0%, #B2EBF2 100%)",
                    body: "linear-gradient(180deg, #E1F5FE 0%, #B3E5FC 50%, #81D4FA 100%)"
                },
                unlocked: false
            },
            {
                id: 4,
                name: "é›¨æ—åŒºè¿·å®«",
                icon: "ğŸŒ´",
                subtitle: "çƒ­å¸¦å¯†æ—",
                target: 200,
                startSpeed: 200,
                minSpeed: 80,
                obstacles: [
                    // è¿·å®«å¢™å£
                    {x: 0, y: 8}, {x: 1, y: 8}, {x: 2, y: 8}, {x: 3, y: 8}, {x: 4, y: 8},
                    {x: 6, y: 8}, {x: 7, y: 8}, {x: 8, y: 8}, {x: 9, y: 8},
                    {x: 11, y: 8}, {x: 12, y: 8}, {x: 13, y: 8}, {x: 14, y: 8},
                    {x: 16, y: 8}, {x: 17, y: 8}, {x: 18, y: 8}, {x: 19, y: 8},
                    {x: 8, y: 0}, {x: 8, y: 1}, {x: 8, y: 2}, {x: 8, y: 3},
                    {x: 8, y: 5}, {x: 8, y: 6}, {x: 8, y: 7},
                    {x: 11, y: 11}, {x: 11, y: 12}, {x: 11, y: 13}, {x: 11, y: 14},
                    {x: 11, y: 16}, {x: 11, y: 17}, {x: 11, y: 18}, {x: 11, y: 19}
                ],
                background: {
                    canvas: "linear-gradient(135deg, #E8F5E9 0%, #A5D6A7 100%)",
                    body: "linear-gradient(180deg, #2E7D32 0%, #388E3C 50%, #43A047 100%)"
                },
                unlocked: false
            },
            {
                id: 5,
                name: "Nickçš„ç»ˆææŒ‘æˆ˜",
                icon: "ğŸ¦Š",
                subtitle: "ä¼ å¥‡ä¹‹è·¯",
                target: 300,
                startSpeed: 150,
                minSpeed: 50,
                obstacles: [
                    // åŠ¨æ€éšæœºéšœç¢ç‰©ï¼Œæ¸¸æˆå¼€å§‹æ—¶ç”Ÿæˆ
                ],
                background: {
                    canvas: "linear-gradient(135deg, #FFE0B2 0%, #FFCC80 100%)",
                    body: "linear-gradient(180deg, #FF6F00 0%, #FF8F00 50%, #FFA726 100%)"
                },
                unlocked: false
            }
        ];

        /* ==================== ç²’å­ç‰¹æ•ˆç±» ==================== */

        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.life = 1;
                this.size = Math.random() * 4 + 2;
                this.color = ['#7B68EE', '#5B4FC4', '#3D2E8F', '#2E8B57'][Math.floor(Math.random() * 4)];
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2; // é‡åŠ›æ•ˆæœ
                this.life -= 0.02;
            }

            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
        function createParticles(x, y, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y));
            }
        }

        // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰ç²’å­
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            particles.forEach(particle => particle.draw());
        }

        /* ==================== åä¸½éŸ³æ•ˆç³»ç»Ÿ ==================== */

        // ä½¿ç”¨Web Audio APIåˆ›å»ºä¸°å¯Œçš„éŸ³æ•ˆ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // ğŸ« åƒè“è“éŸ³æ•ˆ - æ¬¢å¿«çš„ä¸Šå‡éŸ³é˜¶
        function playEatSound() {
            const now = audioContext.currentTime;

            // åˆ›å»ºä¸‰ä¸ªéŸ³ç¬¦çš„å¿«é€Ÿæ—‹å¾‹ (C-E-G å’Œå¼¦ç¶éŸ³)
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5

            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();

                // ä½¿ç”¨ä¸‰è§’æ³¢äº§ç”Ÿæ›´æŸ”å’Œçš„éŸ³è‰²
                osc.type = 'triangle';
                osc.frequency.value = freq;

                // è®¾ç½®ä½é€šæ»¤æ³¢å™¨,è®©å£°éŸ³æ›´æ¸©æš–
                filter.type = 'lowpass';
                filter.frequency.value = 2000;
                filter.Q.value = 1;

                // éŸ³ç¬¦åŒ…ç»œ: å¿«é€Ÿæ”»å‡»,çŸ­æš‚å»¶éŸ³
                const startTime = now + i * 0.05;
                const duration = 0.15;

                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(startTime);
                osc.stop(startTime + duration);
            });

            // æ·»åŠ æ‰“å‡»ä¹æ•ˆæœ (æ¨¡æ‹Ÿ"å•µ"çš„å£°éŸ³)
            const noise = audioContext.createBufferSource();
            const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.05, audioContext.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            for (let i = 0; i < noiseData.length; i++) {
                noiseData[i] = Math.random() * 2 - 1;
            }
            noise.buffer = noiseBuffer;

            const noiseFilter = audioContext.createBiquadFilter();
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.value = 1000;
            noiseFilter.Q.value = 10;

            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0.1, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            noise.start(now);
        }

        // ğŸµ æˆå°±è§£é”éŸ³æ•ˆ - èƒœåˆ©å·è§’
        function playAchievementSound() {
            const now = audioContext.currentTime;

            // èƒœåˆ©å·è§’æ—‹å¾‹ (C-E-G-C)
            const melody = [
                {freq: 523.25, time: 0, duration: 0.15},      // C5
                {freq: 659.25, time: 0.12, duration: 0.15},   // E5
                {freq: 783.99, time: 0.24, duration: 0.15},   // G5
                {freq: 1046.50, time: 0.36, duration: 0.3}    // C6
            ];

            melody.forEach(note => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = note.freq;

                const startTime = now + note.time;
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.25, startTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + note.duration);

                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(startTime);
                osc.stop(startTime + note.duration);
            });

            // æ·»åŠ é—ªäº®çš„é«˜éŸ³ç‚¹ç¼€
            [1047, 1319, 1568].forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq;

                const startTime = now + 0.4 + i * 0.05;
                gain.gain.setValueAtTime(0.15, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);

                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.1);
            });
        }

        // ğŸ’¥ æ¸¸æˆç»“æŸéŸ³æ•ˆ - æˆå‰§æ€§çš„ä¸‹é™
        function playGameOverSound() {
            const now = audioContext.currentTime;

            // ä¸»éŸ³æ•ˆ: æˆå‰§æ€§çš„ä¸‹æ»‘éŸ³
            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();

            osc1.type = 'sawtooth';
            osc1.frequency.setValueAtTime(440, now);
            osc1.frequency.exponentialRampToValueAtTime(110, now + 0.5);

            gain1.gain.setValueAtTime(0.3, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

            osc1.connect(gain1);
            gain1.connect(audioContext.destination);
            osc1.start(now);
            osc1.stop(now + 0.5);

            // æ·»åŠ ä½éŸ³è½°é¸£
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();

            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(220, now);
            osc2.frequency.exponentialRampToValueAtTime(55, now + 0.6);

            gain2.gain.setValueAtTime(0.2, now);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);

            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.start(now);
            osc2.stop(now + 0.6);

            // æ·»åŠ "ç¢°æ’"å™ªéŸ³æ•ˆæœ
            const noise = audioContext.createBufferSource();
            const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            for (let i = 0; i < noiseData.length; i++) {
                noiseData[i] = (Math.random() * 2 - 1) * Math.exp(-i / noiseData.length * 3);
            }
            noise.buffer = noiseBuffer;

            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0.3, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

            noise.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            noise.start(now);
        }

        // âš¡ åŠ é€ŸéŸ³æ•ˆ - ä¸Šå‡çš„å—–å—–å£°
        function playSpeedUpSound() {
            const now = audioContext.currentTime;

            // å¿«é€Ÿä¸Šå‡éŸ³
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.2);

            filter.type = 'highpass';
            filter.frequency.value = 500;

            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);

            osc.start(now);
            osc.stop(now + 0.2);

            // æ·»åŠ "å—–"çš„å™ªéŸ³
            const noise = audioContext.createBufferSource();
            const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.15, audioContext.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            for (let i = 0; i < noiseData.length; i++) {
                noiseData[i] = Math.random() * 2 - 1;
            }
            noise.buffer = noiseBuffer;

            const noiseFilter = audioContext.createBiquadFilter();
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.value = 1000;

            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0.15, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            noise.start(now);
        }

        // ğŸ® æ¸¸æˆå¼€å§‹éŸ³æ•ˆ - æ¬¢å¿«çš„å¼€åœº
        function playStartSound() {
            const now = audioContext.currentTime;

            // å¿«é€Ÿä¸Šå‡ç¶éŸ³ (C-E-G-C)
            const notes = [261.63, 329.63, 392.00, 523.25];

            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq;

                const startTime = now + i * 0.08;
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(startTime);
                osc.stop(startTime + 0.2);
            });
        }

        // ğŸµ èƒŒæ™¯ç¯å¢ƒéŸ³ - è½»æŸ”çš„åŸå¸‚æ°›å›´(å¯é€‰)
        let ambientSound = null;
        let ambientGain = null;

        function startAmbientSound() {
            if (ambientSound) return; // å¦‚æœå·²ç»åœ¨æ’­æ”¾,ä¸é‡å¤åˆ›å»º

            const now = audioContext.currentTime;

            // åˆ›å»ºä½é¢‘ç¯å¢ƒéŸ³
            ambientSound = audioContext.createOscillator();
            ambientGain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();

            ambientSound.type = 'sine';
            ambientSound.frequency.value = 110; // A2

            filter.type = 'lowpass';
            filter.frequency.value = 200;

            ambientGain.gain.setValueAtTime(0, now);
            ambientGain.gain.linearRampToValueAtTime(0.03, now + 2); // ç¼“æ…¢æ·¡å…¥

            ambientSound.connect(filter);
            filter.connect(ambientGain);
            ambientGain.connect(audioContext.destination);

            ambientSound.start(now);
        }

        function stopAmbientSound() {
            if (!ambientSound) return;

            const now = audioContext.currentTime;
            ambientGain.gain.linearRampToValueAtTime(0, now + 1); // ç¼“æ…¢æ·¡å‡º

            setTimeout(() => {
                if (ambientSound) {
                    ambientSound.stop();
                    ambientSound = null;
                    ambientGain = null;
                }
            }, 1100);
        }

        /* ==================== å…³å¡ç³»ç»Ÿå‡½æ•° ==================== */

        // æ˜¾ç¤ºå…³å¡é€‰æ‹©ç•Œé¢
        function showLevelSelect() {
            document.getElementById('levelSelect').classList.add('show');
            renderLevelSelect();
        }

        // å…³é—­å…³å¡é€‰æ‹©ç•Œé¢
        function closeLevelSelect() {
            document.getElementById('levelSelect').classList.remove('show');
        }

        // æ¸²æŸ“å…³å¡é€‰æ‹©ç•Œé¢
        function renderLevelSelect() {
            const levelGrid = document.getElementById('levelGrid');
            levelGrid.innerHTML = '';

            levels.forEach(level => {
                const card = document.createElement('div');
                card.className = 'level-card';

                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                const isCompleted = achievements[`level${level.id}Complete`];
                if (isCompleted) {
                    card.classList.add('completed');
                }

                // æ£€æŸ¥æ˜¯å¦è§£é”
                if (!level.unlocked) {
                    card.classList.add('locked');
                }

                card.innerHTML = `
                    <div class="level-icon">${level.icon}</div>
                    <div class="level-name">${level.name}</div>
                    <div class="level-subtitle">${level.subtitle}</div>
                    <div class="level-target">ç›®æ ‡: ${level.target}åˆ†</div>
                    ${!level.unlocked ? '<div class="level-lock">ğŸ”’</div>' : ''}
                    ${isCompleted ? '<div class="level-check">âœ…</div>' : ''}
                `;

                // åªæœ‰è§£é”çš„å…³å¡å¯ä»¥ç‚¹å‡»
                if (level.unlocked) {
                    card.onclick = () => selectLevel(level.id);
                }

                levelGrid.appendChild(card);
            });

            // æ›´æ–°è¿›åº¦æ¡
            updateProgress();
        }

        // é€‰æ‹©å…³å¡
        function selectLevel(levelId) {
            currentLevel = levelId;
            loadLevel(levelId);
            closeLevelSelect();

            // æ˜¾ç¤ºå…³å¡ä¿¡æ¯
            const level = levels[levelId - 1];
            showAchievement(`è¿›å…¥å…³å¡ ${levelId}`, `${level.icon} ${level.name}`);
        }

        // åŠ è½½å…³å¡
        function loadLevel(levelId) {
            const level = levels[levelId - 1];

            // è®¾ç½®å…³å¡å‚æ•°
            gameSpeed = level.startSpeed;
            obstacles = [...level.obstacles]; // å¤åˆ¶éšœç¢ç‰©æ•°ç»„

            // æ›´æ–°UIæ˜¾ç¤º
            document.getElementById('currentLevelIcon').textContent = level.icon;
            document.getElementById('currentLevelName').textContent = `ç¬¬${levelId}å…³ Â· ${level.name}`;
            document.getElementById('currentTarget').textContent = level.target;

            // æ›´æ–°èƒŒæ™¯é¢œè‰²
            document.body.style.background = level.background.body;
            document.body.style.backgroundSize = '200% 200%';

            // æ›´æ–°ç”»å¸ƒèƒŒæ™¯
            canvas.style.background = level.background.canvas;

            // é‡ç»˜ç”»é¢
            draw();
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            let completedCount = 0;
            levels.forEach(level => {
                if (achievements[`level${level.id}Complete`]) {
                    completedCount++;
                }
            });

            const progress = (completedCount / levels.length) * 100;
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = Math.round(progress) + '%';

            // æ›´æ–°æˆå°±è®¡æ•°
            let achievementCount = 0;
            Object.values(achievements).forEach(val => {
                if (val) achievementCount++;
            });
            document.getElementById('achievementCount').textContent = achievementCount;
        }

        // æ£€æŸ¥å…³å¡é€šå…³
        function checkLevelComplete() {
            const level = levels[currentLevel - 1];

            if (score >= level.target) {
                // æ ‡è®°å½“å‰å…³å¡å®Œæˆ
                achievements[`level${currentLevel}Complete`] = true;

                // è§£é”ä¸‹ä¸€å…³
                if (currentLevel < levels.length) {
                    levels[currentLevel].unlocked = true;
                }

                // ä¿å­˜è¿›åº¦
                saveLevelProgress();

                // æ˜¾ç¤ºé€šå…³æç¤º
                setTimeout(() => {
                    const nextLevel = currentLevel < levels.length ? levels[currentLevel].name : 'å·²é€šå…³æ‰€æœ‰å…³å¡!';
                    showAchievement(`ğŸ‰ å…³å¡${currentLevel}é€šå…³!`, currentLevel < levels.length ? `è§£é”ä¸‹ä¸€å…³: ${nextLevel}` : 'æ­å–œé€šå…³å…¨éƒ¨å…³å¡!');
                    playAchievementSound();
                }, 500);

                return true;
            }
            return false;
        }

        // ä¿å­˜å…³å¡è¿›åº¦
        function saveLevelProgress() {
            const progress = {
                achievements: achievements,
                unlockedLevels: levels.map(l => l.unlocked)
            };
            localStorage.setItem('snakeLevelProgress', JSON.stringify(progress));
        }

        // åŠ è½½å…³å¡è¿›åº¦
        function loadLevelProgress() {
            const saved = localStorage.getItem('snakeLevelProgress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    // æ¢å¤æˆå°±çŠ¶æ€
                    Object.assign(achievements, progress.achievements);
                    // æ¢å¤å…³å¡è§£é”çŠ¶æ€
                    progress.unlockedLevels.forEach((unlocked, index) => {
                        if (levels[index]) {
                            levels[index].unlocked = unlocked;
                        }
                    });
                } catch (e) {
                    console.error('åŠ è½½è¿›åº¦å¤±è´¥:', e);
                }
            }
        }

        /* ==================== æˆå°±æç¤º ==================== */

        function showAchievement(title, message) {
            // åˆ›å»ºæˆå°±æç¤ºå…ƒç´ 
            const achievementDiv = document.createElement('div');
            achievementDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4A90E2, #3B7BC4);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(74, 144, 226, 0.5);
                z-index: 10000;
                animation: slideIn 0.5s ease;
                font-family: -apple-system, sans-serif;
            `;
            achievementDiv.innerHTML = `
                <div style="font-size: 20px; margin-bottom: 5px;">ğŸ† ${title}</div>
                <div style="font-size: 14px; opacity: 0.9;">${message}</div>
            `;

            document.body.appendChild(achievementDiv);

            setTimeout(() => {
                achievementDiv.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(achievementDiv);
                }, 500);
            }, 3000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // æ£€æŸ¥æˆå°±
        function checkAchievements() {
            if (!achievements.firstBlueberry && score >= 10) {
                achievements.firstBlueberry = true;
                showAchievement('ç¬¬ä¸€é¢—è“è“', 'æ­å–œä½ æ”¶é›†äº†ç¬¬ä¸€é¢—è“è“ï¼');
                playAchievementSound(); // ğŸ”Š æ’­æ”¾æˆå°±éŸ³æ•ˆ
            }
            if (!achievements.score50 && score >= 50) {
                achievements.score50 = true;
                showAchievement('è“è“æ”¶é›†å®¶', 'å·²æ”¶é›†50åˆ†è“è“ï¼');
                playAchievementSound(); // ğŸ”Š æ’­æ”¾æˆå°±éŸ³æ•ˆ
            }
            if (!achievements.score100 && score >= 100) {
                achievements.score100 = true;
                showAchievement('è“è“å¤§å¸ˆ', 'å·²æ”¶é›†100åˆ†è“è“ï¼å‰å®³ï¼');
                playAchievementSound(); // ğŸ”Š æ’­æ”¾æˆå°±éŸ³æ•ˆ
            }
            if (!achievements.speedDemon && gameSpeed <= 150) {
                achievements.speedDemon = true;
                showAchievement('é—ªç”µä¾ ', 'é€Ÿåº¦å·²è¾¾åˆ°æé™ï¼');
                playAchievementSound(); // ğŸ”Š æ’­æ”¾æˆå°±éŸ³æ•ˆ
            }
            if (!achievements.longSnake && snake.length >= 10) {
                achievements.longSnake = true;
                showAchievement('é•¿è›‡ä¼ è¯´', 'Nickçš„å°¾å·´è¶…é•¿å•¦ï¼');
                playAchievementSound(); // ğŸ”Š æ’­æ”¾æˆå°±éŸ³æ•ˆ
            }
        }

        /* ==================== åˆå§‹åŒ–æ¸¸æˆ ==================== */

        // ä»æœ¬åœ°å­˜å‚¨è¯»å–æœ€é«˜åˆ†
        function loadHighScore() {
            const saved = localStorage.getItem('snakeHighScore');
            if (saved) {
                highScore = parseInt(saved);
                document.getElementById('highScore').textContent = highScore;
            }
        }

        // ä¿å­˜æœ€é«˜åˆ†åˆ°æœ¬åœ°å­˜å‚¨
        function saveHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                document.getElementById('highScore').textContent = highScore;
            }
        }

        /* ==================== æ¸¸æˆä¸»å¾ªç¯ ==================== */

        function update() {
            // å¦‚æœæ¸¸æˆæš‚åœï¼Œä¸æ›´æ–°
            if (gamePaused) return;

            // è®¡ç®—è›‡å¤´çš„æ–°ä½ç½®
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};

            // æ£€æŸ¥æ˜¯å¦æ’å¢™
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver();
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ’åˆ°è‡ªå·±
            for (let i = 0; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }

            // ğŸ¢ æ£€æŸ¥æ˜¯å¦æ’åˆ°éšœç¢ç‰©
            for (let obstacle of obstacles) {
                if (head.x === obstacle.x && head.y === obstacle.y) {
                    gameOver();
                    return;
                }
            }

            // å°†æ–°çš„å¤´éƒ¨æ·»åŠ åˆ°è›‡çš„æ•°ç»„å¼€å¤´
            snake.unshift(head);

            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (head.x === foodX && head.y === foodY) {
                // ğŸ‰ åƒåˆ°è“è“ç‰¹æ•ˆ
                const particleX = foodX * gridSize + gridSize / 2;
                const particleY = foodY * gridSize + gridSize / 2;
                createParticles(particleX, particleY, 20);

                // ğŸ”Š æ’­æ”¾éŸ³æ•ˆ
                playEatSound();

                // ğŸ’« è§¦å‘åƒé£Ÿç‰©åŠ¨ç”»
                eatAnimation = 10;

                // åˆ†æ•°å¢åŠ 
                score += 10;
                document.getElementById('score').textContent = score;

                // ç”Ÿæˆæ–°çš„é£Ÿç‰©
                generateFood();

                // ğŸ† æ£€æŸ¥æˆå°±
                checkAchievements();

                // ğŸ¯ æ£€æŸ¥å…³å¡é€šå…³
                checkLevelComplete();

                // æ¯åƒ5ä¸ªé£Ÿç‰©ï¼Œé€Ÿåº¦åŠ å¿«ï¼ˆæ ¹æ®å…³å¡çš„æœ€ä½é€Ÿåº¦ï¼‰
                const level = levels[currentLevel - 1];
                if (score % 50 === 0 && gameSpeed > level.minSpeed) {
                    gameSpeed -= 20;
                    if (gameSpeed < level.minSpeed) {
                        gameSpeed = level.minSpeed;
                    }
                    clearInterval(gameLoop);
                    gameLoop = setInterval(update, gameSpeed);
                    playSpeedUpSound(); // ğŸ”Š æ’­æ”¾åŠ é€ŸéŸ³æ•ˆ
                }
            } else {
                // å¦‚æœæ²¡åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤å°¾éƒ¨ï¼ˆä¿æŒè›‡çš„é•¿åº¦ä¸å˜ï¼‰
                snake.pop();
            }

            // ç»˜åˆ¶æ¸¸æˆç”»é¢
            draw();
        }

        /* ==================== ç»˜åˆ¶æ¸¸æˆç”»é¢ ==================== */

        function draw() {
            // æ›´æ–°ç²’å­
            updateParticles();

            // æ›´æ–°åƒé£Ÿç‰©åŠ¨ç”»
            if (eatAnimation > 0) eatAnimation--;

            // æ¸…ç©ºç”»å¸ƒ - ä½¿ç”¨æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(1, '#f8f9fa');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶ç½‘æ ¼çº¿ï¼ˆæ›´æŸ”å’Œçš„å‚è€ƒçº¿ï¼‰
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.03)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= tileCount; i++) {
                // å‚ç›´çº¿
                ctx.beginPath();
                ctx.moveTo(i * gridSize, 0);
                ctx.lineTo(i * gridSize, canvas.height);
                ctx.stroke();
                // æ°´å¹³çº¿
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize);
                ctx.lineTo(canvas.width, i * gridSize);
                ctx.stroke();
            }

            // ğŸ¢ ç»˜åˆ¶éšœç¢ç‰©
            obstacles.forEach(obstacle => {
                const x = obstacle.x * gridSize;
                const y = obstacle.y * gridSize;

                // æ ¹æ®å…³å¡ç»˜åˆ¶ä¸åŒé£æ ¼çš„éšœç¢ç‰©
                if (currentLevel === 2) {
                    // ç¬¬2å…³: è“è‰²å»ºç­‘
                    const buildingGradient = ctx.createLinearGradient(x, y, x + gridSize, y + gridSize);
                    buildingGradient.addColorStop(0, '#5C6BC0');
                    buildingGradient.addColorStop(1, '#3F51B5');
                    ctx.fillStyle = buildingGradient;
                    ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2);

                    // çª—æˆ·æ•ˆæœ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(x + 4, y + 4, 4, 4);
                    ctx.fillRect(x + 12, y + 4, 4, 4);
                    ctx.fillRect(x + 4, y + 12, 4, 4);
                    ctx.fillRect(x + 12, y + 12, 4, 4);
                } else if (currentLevel === 3) {
                    // ç¬¬3å…³: ç™½è‰²å†°å—
                    const iceGradient = ctx.createRadialGradient(
                        x + gridSize / 2, y + gridSize / 2, 0,
                        x + gridSize / 2, y + gridSize / 2, gridSize / 2
                    );
                    iceGradient.addColorStop(0, '#E1F5FE');
                    iceGradient.addColorStop(0.7, '#B3E5FC');
                    iceGradient.addColorStop(1, '#81D4FA');
                    ctx.fillStyle = iceGradient;
                    ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2);

                    // å†°æ™¶æ•ˆæœ
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x + gridSize / 2, y + 3);
                    ctx.lineTo(x + gridSize / 2, y + gridSize - 3);
                    ctx.moveTo(x + 3, y + gridSize / 2);
                    ctx.lineTo(x + gridSize - 3, y + gridSize / 2);
                    ctx.stroke();
                } else if (currentLevel === 4) {
                    // ç¬¬4å…³: æ£•è‰²æ ‘å¹²
                    const treeGradient = ctx.createLinearGradient(x, y, x + gridSize, y);
                    treeGradient.addColorStop(0, '#6D4C41');
                    treeGradient.addColorStop(0.5, '#5D4037');
                    treeGradient.addColorStop(1, '#4E342E');
                    ctx.fillStyle = treeGradient;
                    ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2);

                    // æ ‘çš®çº¹ç†
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x + 5, y);
                    ctx.lineTo(x + 5, y + gridSize);
                    ctx.moveTo(x + 15, y);
                    ctx.lineTo(x + 15, y + gridSize);
                    ctx.stroke();
                } else {
                    // é»˜è®¤éšœç¢ç‰©æ ·å¼
                    ctx.fillStyle = '#757575';
                    ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2);
                }

                // éšœç¢ç‰©è¾¹æ¡†
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + 1, y + 1, gridSize - 2, gridSize - 2);
            });

            // ç»˜åˆ¶è›‡
            snake.forEach((segment, index) => {
                if (index === 0) {
                    // ğŸ¦Š ä½¿ç”¨ç‹ç‹¸å›¾ç‰‡ä½œä¸ºè›‡å¤´
                    if (imageLoaded) {
                        // è®¡ç®—åƒé£Ÿç‰©æ—¶çš„æ”¾å¤§æ•ˆæœ
                        const scale = 1 + (eatAnimation / 10) * 0.3;
                        const centerX = segment.x * gridSize + gridSize / 2;
                        const centerY = segment.y * gridSize + gridSize / 2;

                        // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€
                        ctx.save();

                        // åº”ç”¨æ”¾å¤§å˜æ¢
                        ctx.translate(centerX, centerY);
                        ctx.scale(scale, scale);
                        ctx.translate(-centerX, -centerY);

                        // è®¾ç½®åœ†å½¢è£å‰ªåŒºåŸŸï¼ˆè®©å›¾ç‰‡æ˜¾ç¤ºä¸ºåœ†å½¢ï¼‰
                        ctx.beginPath();
                        ctx.arc(
                            centerX,
                            centerY,
                            gridSize / 2 - 1,
                            0,
                            Math.PI * 2
                        );
                        ctx.clip();

                        // ç»˜åˆ¶ç‹ç‹¸å›¾ç‰‡
                        ctx.drawImage(
                            foxImage,
                            segment.x * gridSize,
                            segment.y * gridSize,
                            gridSize,
                            gridSize
                        );

                        // æ¢å¤ç”»å¸ƒçŠ¶æ€
                        ctx.restore();

                        // ç»˜åˆ¶åœ†å½¢è¾¹æ¡†ï¼ˆå¸¦å‘å…‰æ•ˆæœï¼‰
                        const glowIntensity = eatAnimation / 10;
                        if (glowIntensity > 0) {
                            ctx.shadowBlur = 15 * glowIntensity;
                            ctx.shadowColor = '#F59E0B';
                        }
                        ctx.strokeStyle = '#F59E0B';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(
                            centerX,
                            centerY,
                            (gridSize / 2 - 1) * scale,
                            0,
                            Math.PI * 2
                        );
                        ctx.stroke();
                        ctx.shadowBlur = 0;
                    } else {
                        // å›¾ç‰‡æœªåŠ è½½æ—¶æ˜¾ç¤ºé»„è‰²åœ†å½¢ä½œä¸ºå ä½ç¬¦
                        const headGradient = ctx.createRadialGradient(
                            segment.x * gridSize + gridSize / 2,
                            segment.y * gridSize + gridSize / 2,
                            0,
                            segment.x * gridSize + gridSize / 2,
                            segment.y * gridSize + gridSize / 2,
                            gridSize / 2
                        );
                        headGradient.addColorStop(0, '#FCD34D');
                        headGradient.addColorStop(1, '#F59E0B');
                        ctx.fillStyle = headGradient;

                        ctx.beginPath();
                        ctx.arc(
                            segment.x * gridSize + gridSize / 2,
                            segment.y * gridSize + gridSize / 2,
                            gridSize / 2 - 2,
                            0,
                            Math.PI * 2
                        );
                        ctx.fill();
                    }

                } else {
                    // è›‡èº« - é»„è‰²æ¸å˜
                    const alpha = 1 - (index / snake.length) * 0.6;
                    const bodyGradient = ctx.createRadialGradient(
                        segment.x * gridSize + gridSize / 2,
                        segment.y * gridSize + gridSize / 2,
                        0,
                        segment.x * gridSize + gridSize / 2,
                        segment.y * gridSize + gridSize / 2,
                        gridSize / 2
                    );
                    bodyGradient.addColorStop(0, `rgba(252, 211, 77, ${alpha})`);
                    bodyGradient.addColorStop(1, `rgba(245, 158, 11, ${alpha * 0.8})`);
                    ctx.fillStyle = bodyGradient;

                    // ç»˜åˆ¶åœ†è§’çŸ©å½¢
                    drawRoundRect(
                        segment.x * gridSize + 2,
                        segment.y * gridSize + 2,
                        gridSize - 4,
                        gridSize - 4,
                        6
                    );
                }
            });

            // ğŸ« ç»˜åˆ¶è“è“é£Ÿç‰©ï¼ˆç–¯ç‹‚åŠ¨ç‰©åŸé£æ ¼ï¼‰
            const time = Date.now() / 1000;
            const pulse = Math.sin(time * 3) * 0.1 + 1; // è„‰åŠ¨æ•ˆæœ

            const centerX = foodX * gridSize + gridSize / 2;
            const centerY = foodY * gridSize + gridSize / 2;

            // è“è“ä¸»ä½“ - è“ç´«è‰²æ¸å˜
            const blueberryGradient = ctx.createRadialGradient(
                centerX - 2,
                centerY - 2,
                0,
                centerX,
                centerY,
                gridSize / 2 * pulse
            );
            blueberryGradient.addColorStop(0, '#7B68EE');
            blueberryGradient.addColorStop(0.5, '#5B4FC4');
            blueberryGradient.addColorStop(1, '#3D2E8F');
            ctx.fillStyle = blueberryGradient;

            ctx.beginPath();
            ctx.arc(centerX, centerY, gridSize / 2 - 2, 0, Math.PI * 2);
            ctx.fill();

            // è“è“é¡¶éƒ¨çš„å°èŠ±å† 
            ctx.fillStyle = '#2E8B57';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - gridSize / 2 + 2);
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const x = centerX + Math.cos(angle) * 2;
                const y = centerY - gridSize / 2 + 2 + Math.sin(angle) * 2;
                ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();

            // è“è“é«˜å…‰
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.arc(centerX - 3, centerY - 3, 2.5, 0, Math.PI * 2);
            ctx.fill();

            // è“è“çº¹ç†ï¼ˆå°ç‚¹ç‚¹ï¼‰
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const dotX = centerX - 4 + i * 4;
                    const dotY = centerY - 4 + j * 4;
                    ctx.beginPath();
                    ctx.arc(dotX, dotY, 0.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // è“è“å…‰æ™•
            ctx.strokeStyle = `rgba(123, 104, 238, ${0.4 * pulse})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, gridSize / 2, 0, Math.PI * 2);
            ctx.stroke();

            // ğŸ¨ ç»˜åˆ¶æ‰€æœ‰ç²’å­ç‰¹æ•ˆï¼ˆåœ¨æœ€ä¸Šå±‚ï¼‰
            drawParticles();
        }

        // ç»˜åˆ¶åœ†è§’çŸ©å½¢çš„è¾…åŠ©å‡½æ•°
        function drawRoundRect(x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
        }

        /* ==================== ç”Ÿæˆé£Ÿç‰© ==================== */

        function generateFood() {
            // ç”Ÿæˆéšæœºä½ç½®
            foodX = Math.floor(Math.random() * tileCount);
            foodY = Math.floor(Math.random() * tileCount);

            // ç¡®ä¿é£Ÿç‰©ä¸ä¼šç”Ÿæˆåœ¨è›‡èº«ä¸Š
            for (let segment of snake) {
                if (segment.x === foodX && segment.y === foodY) {
                    // å¦‚æœé‡å äº†ï¼Œé‡æ–°ç”Ÿæˆ
                    generateFood();
                    return;
                }
            }

            // ğŸ¢ ç¡®ä¿é£Ÿç‰©ä¸ä¼šç”Ÿæˆåœ¨éšœç¢ç‰©ä¸Š
            for (let obstacle of obstacles) {
                if (obstacle.x === foodX && obstacle.y === foodY) {
                    // å¦‚æœé‡å äº†ï¼Œé‡æ–°ç”Ÿæˆ
                    generateFood();
                    return;
                }
            }
        }

        /* ==================== æ¸¸æˆæ§åˆ¶å‡½æ•° ==================== */

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            // åŠ è½½å½“å‰å…³å¡é…ç½®
            loadLevel(currentLevel);

            // é‡ç½®æ¸¸æˆçŠ¶æ€ï¼ˆå¼€å±€3èŠ‚è›‡èº«ï¼‰
            snake = [
                {x: 10, y: 10},  // è›‡å¤´
                {x: 9, y: 10},   // è›‡èº«ç¬¬äºŒèŠ‚
                {x: 8, y: 10}    // è›‡èº«ç¬¬ä¸‰èŠ‚ï¼ˆå°¾å·´ï¼‰
            ];
            dx = 1;  // åˆå§‹å‘å³ç§»åŠ¨
            dy = 0;
            score = 0;
            gamePaused = false;
            document.getElementById('score').textContent = score;

            // é‡ç½®å½“å‰å…³å¡çš„åŸºç¡€æˆå°±çŠ¶æ€ï¼ˆä½†ä¿ç•™å…³å¡é€šå…³è®°å½•ï¼‰
            const levelAchievements = {
                level1Complete: achievements.level1Complete,
                level2Complete: achievements.level2Complete,
                level3Complete: achievements.level3Complete,
                level4Complete: achievements.level4Complete,
                level5Complete: achievements.level5Complete
            };
            achievements = {
                firstBlueberry: false,
                score50: false,
                score100: false,
                speedDemon: false,
                longSnake: false,
                ...levelAchievements
            };

            // ç”Ÿæˆç¬¬ä¸€ä¸ªé£Ÿç‰©
            generateFood();

            // éšè—æ¸¸æˆç»“æŸæç¤º
            document.getElementById('gameOver').classList.remove('show');

            // æ¸…é™¤æ—§çš„æ¸¸æˆå¾ªç¯
            if (gameLoop) {
                clearInterval(gameLoop);
            }

            // å¼€å§‹æ–°çš„æ¸¸æˆå¾ªç¯
            gameRunning = true;
            gameLoop = setInterval(update, gameSpeed);

            // ğŸ”Š æ’­æ”¾æ¸¸æˆå¼€å§‹éŸ³æ•ˆ
            playStartSound();

            // ğŸµ å¯åŠ¨èƒŒæ™¯ç¯å¢ƒéŸ³ï¼ˆå¯é€‰,éå¸¸è½»æŸ”ï¼‰
            startAmbientSound();

            // ç»˜åˆ¶åˆå§‹ç”»é¢
            draw();
        }

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            if (!gameRunning) return;
            gamePaused = !gamePaused;

            if (gamePaused) {
                // æš‚åœæ—¶åœ¨ç”»å¸ƒä¸­å¤®æ˜¾ç¤ºæç¤º
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '30px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆæš‚åœ', canvas.width / 2, canvas.height / 2);
            } else {
                // ç»§ç»­æ—¶é‡æ–°ç»˜åˆ¶
                draw();
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);

            // ğŸ”Š æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
            playGameOverSound();

            // ğŸµ åœæ­¢èƒŒæ™¯ç¯å¢ƒéŸ³
            stopAmbientSound();

            // ä¿å­˜æœ€é«˜åˆ†
            saveHighScore();

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOver').classList.add('show');
        }

        /* ==================== é”®ç›˜æ§åˆ¶ ==================== */

        document.addEventListener('keydown', (e) => {
            // ç©ºæ ¼é”®æš‚åœ
            if (e.code === 'Space') {
                e.preventDefault();
                togglePause();
                return;
            }

            // æ–¹å‘é”®æ§åˆ¶
            switch(e.code) {
                case 'ArrowUp':
                    // ä¸èƒ½ç›´æ¥æ‰å¤´ï¼ˆå¦‚æœå½“å‰å‘ä¸‹ç§»åŠ¨ï¼Œä¸èƒ½ç›´æ¥å‘ä¸Šï¼‰
                    if (dy === 0) {
                        dx = 0;
                        dy = -1;
                    }
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    if (dy === 0) {
                        dx = 0;
                        dy = 1;
                    }
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (dx === 0) {
                        dx = -1;
                        dy = 0;
                    }
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    if (dx === 0) {
                        dx = 1;
                        dy = 0;
                    }
                    e.preventDefault();
                    break;
            }
        });

        /* ==================== é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ– ==================== */

        // åŠ è½½æœ€é«˜åˆ†
        loadHighScore();

        // ğŸ—ºï¸ åŠ è½½å…³å¡è¿›åº¦
        loadLevelProgress();

        // ğŸ® åŠ è½½ç¬¬1å…³(é»˜è®¤å…³å¡)
        loadLevel(1);

        // ç»˜åˆ¶åˆå§‹ç”»é¢ï¼ˆç©ºç™½æ¸¸æˆæ¿ï¼‰
        draw();

        // åœ¨ç”»å¸ƒä¸­å¤®æ˜¾ç¤ºå¼€å§‹æç¤º
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#86868b';
        ctx.font = '24px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ç‚¹å‡»"é€‰æ‹©å…³å¡"æˆ–"å¼€å§‹æ¸¸æˆ"', canvas.width / 2, canvas.height / 2);
    </script>
</body>
</html>
