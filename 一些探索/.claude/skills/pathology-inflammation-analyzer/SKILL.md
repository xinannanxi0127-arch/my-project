---
name: pathology-inflammation-analyzer
description: 自动分析病理切片图像，检测并标注炎症损伤严重的区域，生成带有红色圆圈和箭头标记的标注图像。当用户需要分析病理图像、标注炎症区域、或进行组织学病理分析时使用此技能。
allowed-tools: Read, Write, Bash, Glob, Grep
---

# 病理图像炎症区域分析器

## 功能概述

这是一个专业的病理图像自动分析工具，能够：
- 自动检测病理切片中的炎症区域
- 基于颜色和细胞密度进行智能识别
- 用医学标准的箭头和红色圆圈标注严重区域
- 生成包含检测过程的调试图像
- 批量处理多张病理图像

## 使用场景

当用户提出以下需求时，自动激活此技能：
- "分析这张病理图像"
- "标注炎症区域"
- "找出病理切片中的炎症损伤"
- "检测组织学异常"
- "标记病理图像中的问题区域"

## 工作流程

### 步骤 1: 环境准备
1. 检查是否存在 `病理探究` 项目目录
2. 如果不存在，创建完整的项目结构
3. 确保 Python 依赖已安装（opencv-python, numpy, matplotlib）

### 步骤 2: 图像处理
1. 将用户提供的图像保存到 `病理探究/input_images/` 目录
2. 如果用户提供图像路径，复制图像到输入目录
3. 支持的格式：JPG, JPEG, PNG, BMP, TIFF

### 步骤 3: 运行分析
1. 执行病理分析程序：`python pathology_analyzer.py`
2. 程序会自动：
   - 检测炎症区域（基于紫色/紫红色和高密度特征）
   - 评估严重程度（颜色强度 × 区域面积）
   - 标注最严重的 3 个区域（符合医学图像标注标准）
   - 生成标注图像和调试图像

### 步骤 4: 结果展示
1. 显示检测到的炎症区域数量
2. 提供标注后图像的路径
3. 说明如何查看结果
4. 给出调整参数的建议（如果需要）

## 标注样式说明

生成的标注图像采用医学标准标注风格：
- **纯黑色箭头**：简洁专业的医学标注风格
- **白色轮廓**：增强箭头在任何背景下的可见性
- **箭头长度**：60 像素，短小精悍，不遮挡组织细节
- **智能方向**：根据目标位置自动调整箭头方向
- **默认数量**：每个视野标注 3 个不同位置的炎症区域

调试图像包含 4 个面板：
1. 原始图像
2. 炎症区域掩码（二值化）
3. 炎症强度热图
4. 最终标注结果

## 检测原理

该工具基于以下病理学特征：

### 颜色分析
- 检测紫色/紫红色区域（HE 染色的细胞密集区）
- HSV 色彩空间分析
- 可调节的颜色范围参数

### 密度检测
- 识别高密度细胞浸润区域
- 灰度阈值分析
- 形态学操作去除噪声

### 严重程度评分
- 结合颜色强度和区域大小
- 排序找出最严重的区域
- 可配置的最小区域阈值

## 参数调整建议

如果检测效果不理想，可以调整以下参数：

### 修改标注数量
```python
# 在 main() 函数中
analyzer.process_all_images(
    max_arrows=3,      # 默认3个，可改为 1-10 之间的数字
    show_debug=True
)
```

### 调整检测灵敏度
```python
# 在 find_severe_regions() 方法中
min_area=500  # 减小此值会检测更多小区域，增大则只检测大区域
```

### 修改箭头样式
```python
# 在 draw_arrows() 方法中
arrow_distance = 60      # 箭头长度（30-100）
arrow_thickness = 2      # 箭头主体粗细（1-4）
outline_thickness = 4    # 白色轮廓粗细（2-6）
```

## 重要提醒

⚠️ **医学免责声明**
- 本工具仅用于辅助研究和教学
- **不能用于临床诊断**
- 自动检测结果应由专业病理医生审核确认
- 不同染色方法可能需要调整参数

## 输出文件说明

### input_images/
存放原始病理图像的文件夹

### output_images/
存放处理结果的文件夹：
- `annotated_*.jpg` - 带标注的结果图像
- `debug_*.jpg` - 包含检测过程的 4 格调试图

## 示例对话

### 示例 1: 基础分析
**用户**: "请分析这张病理图像，标注出炎症区域"
**助手操作**:
1. 创建或检查项目目录
2. 保存图像到 input_images
3. 运行分析程序
4. 报告检测结果和输出路径

### 示例 2: 批量处理
**用户**: "我有 5 张病理切片，帮我标注所有的炎症区域"
**助手操作**:
1. 将所有图像保存到 input_images
2. 运行批量分析
3. 报告每张图像的检测结果
4. 提供所有输出文件的位置

### 示例 3: 调整参数
**用户**: "标注的区域太多了，只显示最严重的 3 个"
**助手操作**:
1. 修改 max_arrows=3
2. 重新运行分析
3. 确认新的标注效果

## 技术要求

### Python 环境
- Python 3.8 或更高版本
- pip 包管理器

### 依赖库
- opencv-python >= 4.8.0
- numpy >= 1.24.0
- matplotlib >= 3.7.0

### 操作系统
- Windows / macOS / Linux
- 支持中文路径

## 故障排除

### 问题 1: 检测不到炎症区域
**解决方案**: 降低 `min_area` 参数或调整 HSV 颜色范围

### 问题 2: 误报太多
**解决方案**: 增大 `min_area` 参数或减少 `max_arrows` 数量

### 问题 3: 箭头不够明显
**解决方案**: 增加 `circle_radius` 和 `thickness` 参数

### 问题 4: 图像格式不支持
**解决方案**: 将图像转换为 JPG 或 PNG 格式

## 最佳实践

1. **图像质量**: 使用高分辨率的清晰图像
2. **染色标准**: 工具针对 HE 染色优化
3. **先测试**: 先用 1-2 张图像测试效果
4. **专业审核**: 结果需要病理医生确认
5. **参数调优**: 根据具体组织类型调整参数

## 项目结构

```
病理探究/
├── pathology_analyzer.py    # 主程序
├── requirements.txt          # 依赖列表
├── README.md                 # 使用说明
├── input_images/             # 输入图像
│   ├── image1.jpg
│   └── image2.jpg
└── output_images/            # 输出结果
    ├── annotated_image1.jpg
    ├── debug_image1.jpg
    ├── annotated_image2.jpg
    └── debug_image2.jpg
```

## 许可和引用

如果在学术研究中使用本工具，请注明：
- 工具名称：病理图像炎症区域分析器
- 版本：1.0
- 检测方法：基于颜色和密度的自动分析

---

**更新日期**: 2025-12-01
**维护者**: Claude Code AI Assistant
**支持**: 通过 Claude Code 获取技术支持
